# DB 동시성 제어 - MVCC, Lock


## 동시성 제어가 필요한 이유
- 여러 명이 동시에 DB에 접근하면 데이터 꼬임 / 덮어쓰기 / 이상한 값 나올 수 있음
- DB는 이런 상황 막으려고 "동시성 제어" 기능을 사용

<br>


## 대표적인 동시성 제어 방식 두 가지
### 1.  Lock 기반 방식 (전통적인 방법)
- 데이터를 사용할 때 잠금 걸고, 다른 사람이 못 건드리게 막음
- 오라클, MySQL, PostgreSQL 전부 락 기능은 기본으로 지원함

<br>

### 2. MVCC (Multi-Version Concurrency Control)
- 데이터를 아예 복사해서 따로 보여줌
- 두 사용자가 동시에 같은 데이터 조회해도, 서로 다른 버전을 봄
  
<br>


  | 항목            | Lock 방식                | MVCC 방식       |
| ------------- | ---------------------- | ------------- |
| 방식            | 데이터 잠금                 | 데이터 복사(버전 관리) |
| 충돌 방지         | 락으로 제어                 | 각자 다른 버전 보여줌  |
| 장점            | 확실한 충돌 방지              | 빠른 읽기, 대기 없음  |
| 단점            | 대기 많고 데드락 위험           | 복잡, 공간 많이 씀   |
| 오라클           | 락 + MVCC(Undo 기반)      |               |
| MySQL(InnoDB) | 락 + MVCC(버전 컬럼 기반)     |               |
| PostgreSQL    | 락 + MVCC(xmin/xmax 기반) |               |

<br>


### 락 + MVCC 두 방식을 같이 쓴다면?
- 기본적으로 읽기(SELECT) 는 기본적으로 MVCC 기반 쓰기(UPDATE, DELETE, INSERT) 나 트랜잭션 간 충돌 상황에서는 Lock 기반으로 동작.

<br>

### 락 + MVCC 기반이더라도 MVCC 구현 방식이 각자 다르다!
| DB                 | 어떻게 MVCC 하냐                              |
| ------------------ | ---------------------------------------- |
| **MySQL (InnoDB)** | 행에 버전 정보 직접 붙임 (히든 컬럼)                   |
| **PostgreSQL**     | 행에 xmin/xmax 같은 버전 정보 있음                 |
| **Oracle**         | **Undo 영역**에 옛날 데이터 복사해둠 → 필요하면 복원해서 보여줌 |
